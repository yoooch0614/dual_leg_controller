<!-- 待機時静止対応＋パラメータ調整機能付き 6脚ジョイスティック制御 launchファイル -->
<launch>
  <!-- 引数定義 -->
  <arg name="enable_debug" default="true"/>
  <arg name="joystick_device" default="/dev/input/js0"/>
  
  <!-- パラメータ読み込み -->
  <rosparam command="load" file="$(find dual_leg_controller)/config/hexa_leg_params.yaml"/>
  
  <!-- 6脚制御のため3つのdual_leg_controllerを起動 -->
  <!-- USB0に接続された脚（右前と左前） -->
  <node name="dual_leg_controller_usb0" pkg="dual_leg_controller" 
        type="dual_leg_controller_node" args="RF LF" 
        output="screen" respawn="false">
    <rosparam param="debug_mode" subst_value="true">$(arg enable_debug)</rosparam>
  </node>
  
  <!-- USB1に接続された脚（左中と左後） -->
  <node name="dual_leg_controller_usb1" pkg="dual_leg_controller" 
        type="dual_leg_controller_node" args="LM LB" 
        output="screen" respawn="false">
    <rosparam param="debug_mode" subst_value="true">$(arg enable_debug)</rosparam>
  </node>
  
  <!-- USB2に接続された脚（右後と右中） -->
  <node name="dual_leg_controller_usb2" pkg="dual_leg_controller" 
        type="dual_leg_controller_node" args="RB RM" 
        output="screen" respawn="false">
    <rosparam param="debug_mode" subst_value="true">$(arg enable_debug)</rosparam>
  </node>
  
  <!-- ジョイスティックドライバ -->
  <node name="joy_node" pkg="joy" type="joy_node" output="screen">
    <param name="dev" value="$(arg joystick_device)"/>
    <param name="deadzone" value="0.0"/>  <!-- デッドゾーンはカスタムノードで処理 -->
    <param name="autorepeat_rate" value="50"/>  <!-- 50Hz -->
  </node>
  
  <!-- 強化版ジョイスティック入力処理ノード（待機時静止＋パラメータ調整対応） -->
  <node name="enhanced_hexapod_joystick_controller" pkg="dual_leg_controller" 
        type="enhanced_hexapod_joystick_controller_node" output="screen">
    
    <!-- ジョイスティック設定 -->
    <param name="deadzone_radius" value="0.1"/>      <!-- ドリフト防止デッドゾーン -->
    <param name="max_linear_speed" value="80.0"/>    <!-- 最大直進速度 mm/s -->
    <param name="max_angular_speed" value="1.0"/>    <!-- 最大回転速度 rad/s -->
    
    <!-- ボタンマッピング（PS4/Xbox互換） -->
    <param name="enable_button" value="4"/>          <!-- L1/LB: 有効化/無効化 -->
    <param name="emergency_stop_button" value="5"/>  <!-- R1/RB: 緊急停止 -->
    <param name="home_button" value="8"/>            <!-- Start: ホームポジション -->
    <param name="param_mode_button" value="9"/>      <!-- Select/Back: パラメータモード切替 -->
    <param name="param_up_button" value="3"/>        <!-- Y/Triangle: パラメータ増加 -->
    <param name="param_down_button" value="0"/>      <!-- A/X: パラメータ減少 -->
    
    <!-- 軸マッピング -->
    <param name="linear_x_axis" value="1"/>          <!-- 左スティック縦 -->
    <param name="linear_y_axis" value="0"/>          <!-- 左スティック横 -->
    <param name="angular_z_axis" value="3"/>         <!-- 右スティック横 -->
    
    <!-- 軸の反転設定 -->
    <param name="invert_linear_x" value="true"/>     <!-- 前進を正に -->
    <param name="invert_linear_y" value="false"/>
    <param name="invert_angular_z" value="false"/>
    
    <!-- スムーズな遷移パラメータ -->
    <param name="acceleration_limit" value="200.0"/> <!-- mm/s² -->
    <param name="angular_acceleration_limit" value="2.0"/> <!-- rad/s² -->
    <param name="update_rate" value="50.0"/>         <!-- 50Hz -->
    
    <!-- 歩行パラメータ初期値 -->
    <param name="step_height" value="17.0"/>         <!-- ステップ高さ mm -->
    <param name="step_length" value="60.0"/>         <!-- ステップ長さ mm -->
    <param name="cycle_time" value="1.2"/>           <!-- サイクル時間 s -->
    <param name="max_speed" value="80.0"/>           <!-- 最大速度 mm/s -->
  </node>
  
  <!-- 強化版滑らかな6脚歩行制御ノード（待機時静止対応） -->
  <node name="enhanced_smooth_hexapod_controller" pkg="dual_leg_controller" 
        type="enhanced_smooth_hexapod_controller_node" output="screen">
    
    <!-- 歩行パラメータ（動的調整可能） -->
    <param name="step_height" value="17.0"/>
    <param name="step_length" value="60.0"/>
    <param name="cycle_time" value="1.2"/>
    <param name="initial_forward_speed" value="20.0"/>
    
    <!-- さらに滑らかな遷移パラメータ -->
    <param name="direction_change_rate" value="120.0"/>   <!-- 度/秒 -->
    <param name="speed_change_rate" value="80.0"/>        <!-- mm/s² -->
    <param name="angular_change_rate" value="1.5"/>       <!-- rad/s² -->
    
    <!-- トライポッドグループ設定 -->
    <rosparam param="tripod_group_0">["RF", "LM", "RB"]</rosparam>
    <rosparam param="tripod_group_1">["LF", "LB", "RM"]</rosparam>
    
    <!-- 脚配置パラメータ -->
    <rosparam param="leg_angles">[0, 300, 240, 180, 120, 60]</rosparam>
    
    <!-- 動作中断と再開機能 -->
    <param name="allow_gait_interruption" value="true"/>
    <param name="min_step_completion" value="0.3"/>      <!-- 最小ステップ完了率 -->
    
    <!-- 待機時静止機能 -->
    <param name="stop_when_idle" value="true"/>          <!-- 待機時は完全停止 -->
    <param name="idle_timeout" value="1.0"/>             <!-- 1秒で待機状態と判定 -->
    <param name="force_home_when_stopped" value="true"/> <!-- 停止時はホームポジション強制 -->
  </node>
  
  <!-- パラメータ調整状態表示ノード -->
  <node name="hexapod_parameter_display" pkg="dual_leg_controller" 
        type="hexapod_parameter_display_node" output="screen" if="$(arg enable_debug)">
    <param name="display_rate" value="2.0"/>  <!-- 2秒間隔で表示 -->
  </node>
  
  <!-- ジョイスティック状態表示ノード（強化版） -->
  <node name="enhanced_joystick_status_display" pkg="dual_leg_controller" 
        type="enhanced_joystick_status_display.py" output="screen" if="$(arg enable_debug)">
    <param name="display_rate" value="3.0"/>  <!-- 3秒間隔で表示 -->
    <param name="show_parameter_hints" value="true"/>  <!-- パラメータ調整のヒントを表示 -->
  </node>
  
  <!-- 安全監視ノード -->
  <node name="hexapod_safety_monitor" pkg="dual_leg_controller" 
        type="leg_safety_monitor.py" output="screen" if="$(arg enable_debug)">
    <param name="monitor_legs" value="RF,LF,LM,LB,RB,RM"/>
    <param name="position_limit_x_max" value="200.0"/>
    <param name="position_limit_x_min" value="80.0"/>
    <param name="position_limit_z_max" value="-50.0"/>
    <param name="position_limit_z_min" value="-130.0"/>
    <param name="emergency_stop_enabled" value="true"/>
    <param name="idle_position_check" value="true"/>     <!-- 待機位置チェック -->
  </node>
  
  <!-- 歩行状態監視ノード -->
  <node name="hexapod_motion_monitor" pkg="dual_leg_controller" 
        type="hexapod_motion_monitor.py" output="screen" if="$(arg enable_debug)">
    <param name="monitor_topics" value="/cmd_vel,/hexapod/enable"/>
    <param name="idle_detection_threshold" value="0.001"/>  <!-- 静止判定閾値 -->
    <param name="idle_timeout" value="2.0"/>                <!-- 静止タイムアウト -->
  </node>
  
</launch>