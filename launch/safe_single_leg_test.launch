<!-- 安全な単脚歩行テスト用launchファイル -->
<launch>
  <!-- 引数定義 -->
  <arg name="leg_id" default="RF"/>
  <arg name="test_mode" default="true"/>
  <arg name="enable_rviz" default="true"/>
  
  <!-- 基本パラメータ読み込み -->
  <rosparam command="load" file="$(find dual_leg_controller)/config/hexa_leg_params.yaml"/>
  
  <!-- 安全テスト用パラメータ読み込み -->
  <rosparam command="load" file="$(find dual_leg_controller)/config/safe_leg_test_params.yaml"/>
  
  <!-- RF脚用のdual_leg_controllerを起動（テストモードの場合のみ1脚） -->
  <group if="$(arg test_mode)">
    <!-- RF脚のみをテスト用に起動 -->
    <node name="dual_leg_controller_test" pkg="dual_leg_controller" 
          type="dual_leg_controller_node" args="RF LF" output="screen">
      <param name="test_mode" value="true"/>
      <remap from="/asterisk/leg/LF/command/joint_angles" to="/asterisk/leg/LF/command/joint_angles_disabled"/>
      <remap from="/asterisk/leg/LF/command/foot_position" to="/asterisk/leg/LF/command/foot_position_disabled"/>
    </node>
  </group>
  
  <!-- 通常の6脚制御の場合 -->
  <group unless="$(arg test_mode)">
    <include file="$(find dual_leg_controller)/launch/hexa_leg_controller.launch"/>
  </group>
  
  <!-- 安全単脚テストノード -->
  <node name="safe_single_leg_test" pkg="dual_leg_controller" 
        type="safe_single_leg_test_node" output="screen" launch-prefix="xterm -e">
    <param name="target_leg" value="$(arg leg_id)"/>
  </node>
  
  <!-- ログ記録（安全のため） -->
  <node name="safety_logger" pkg="rosbag" type="record" output="screen"
        args="-o /tmp/leg_test_$(arg leg_id) 
              /asterisk/leg/$(arg leg_id)/command/foot_position 
              /asterisk/leg/$(arg leg_id)/state/foot_position 
              /asterisk/leg/$(arg leg_id)/state/read_angle
              /rosout">
  </node>
  
  <!-- URDF表示（可視化用） -->
  <param name="robot_description" 
         command="$(find xacro)/xacro $(find dual_leg_controller)/model/urdf/hexa_leg.xacro"/>
  
  <node name="robot_state_publisher" pkg="robot_state_publisher" 
        type="robot_state_publisher" output="screen"/>
  
  <!-- RViz可視化 -->
  <group if="$(arg enable_rviz)">
    <node name="rviz" pkg="rviz" type="rviz" output="screen"
          args="-d $(find dual_leg_controller)/config/single_leg_test.rviz"/>
  </group>
  
  <!-- 監視ノード（位置の異常値検出） -->
  <node name="leg_safety_monitor" pkg="dual_leg_controller" 
        type="leg_safety_monitor.py" output="screen">
    <param name="target_leg" value="$(arg leg_id)"/>
    <param name="position_tolerance" value="10.0"/>
    <param name="velocity_limit" value="100.0"/>
  </node>
  
  <!-- 初期化完了の確認 -->
  <node name="initialization_checker" pkg="dual_leg_controller" 
        type="check_initialization.py" output="screen">
    <param name="wait_time" value="3.0"/>
  </node>

</launch>