
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6脚ロボット監視システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .status-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .leg-status {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .leg-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .leg-position {
            font-family: monospace;
            font-size: 0.9em;
            margin: 5px 0;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }
        .connected { background-color: #28a745; }
        .disconnected { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🦾 6脚ロボット リアルタイム監視システム</h1>
            <p>足先動作・歩行パターン・システム状態の総合監視</p>
        </div>
        
        <div id="connectionStatus" class="connection-status disconnected">
            🔴 接続中...
        </div>
        
        <div class="status-panel">
            <div class="status-card">
                <h3>🤖 歩行状態</h3>
                <div id="walkingStatus" class="status-value">待機中</div>
            </div>
            <div class="status-card">
                <h3>🎯 協調性</h3>
                <div id="coordinationScore" class="status-value">0%</div>
            </div>
            <div class="status-card">
                <h3>⚖️ 安定性</h3>
                <div id="stabilityMargin" class="status-value">0mm</div>
            </div>
            <div class="status-card">
                <h3>⏱️ 稼働時間</h3>
                <div id="uptime" class="status-value">0s</div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-panel">
                <h3>3D足先軌道</h3>
                <div id="trajectory3d" style="height: 400px;"></div>
            </div>
            <div class="chart-panel">
                <h3>XY平面軌道</h3>
                <div id="trajectoryXY" style="height: 400px;"></div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-panel">
                <h3>足先速度</h3>
                <div id="velocityChart" style="height: 300px;"></div>
            </div>
            <div class="chart-panel">
                <h3>歩行メトリクス</h3>
                <div id="metricsChart" style="height: 300px;"></div>
            </div>
        </div>
        
        <div class="leg-status">
            <div class="leg-card">
                <h4 style="color: #dc3545;">🦵 RF (右前脚)</h4>
                <div id="rf-position" class="leg-position">位置: [0, 0, 0]</div>
                <div id="rf-velocity" class="leg-position">速度: 0 mm/s</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #007bff;">🦵 LF (左前脚)</h4>
                <div id="lf-position" class="leg-position">位置: [0, 0, 0]</div>
                <div id="lf-velocity" class="leg-position">速度: 0 mm/s</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #28a745;">🦵 LM (左中脚)</h4>
                <div id="lm-position" class="leg-position">位置: [0, 0, 0]</div>
                <div id="lm-velocity" class="leg-position">速度: 0 mm/s</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #ffc107;">🦵 LB (左後脚)</h4>
                <div id="lb-position" class="leg-position">位置: [0, 0, 0]</div>
                <div id="lb-velocity" class="leg-position">速度: 0 mm/s</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #6f42c1;">🦵 RB (右後脚)</h4>
                <div id="rb-position" class="leg-position">位置: [0, 0, 0]</div>
                <div id="rb-velocity" class="leg-position">速度: 0 mm/s</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #fd7e14;">🦵 RM (右中脚)</h4>
                <div id="rm-position" class="leg-position">位置: [0, 0, 0]</div>
                <div id="rm-velocity" class="leg-position">速度: 0 mm/s</div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO接続
        const socket = io();
        
        // 接続状態の管理
        socket.on('connect', function() {
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionStatus').innerHTML = '🟢 接続済み';
        });
        
        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionStatus').innerHTML = '🔴 切断';
        });
        
        // データ更新の処理
        socket.on('data_update', function(data) {
            updateStatusPanel(data.system_status);
            updateLegPositions(data.positions, data.velocities);
            updateCharts(data.trajectories, data.velocities);
            updateMetrics(data.metrics);
        });
        
        function updateStatusPanel(status) {
            document.getElementById('walkingStatus').textContent = 
                status.is_walking ? '歩行中' : '待機中';
            document.getElementById('walkingStatus').className = 
                'status-value ' + (status.is_walking ? 'status-good' : 'status-warning');
            
            document.getElementById('coordinationScore').textContent = 
                Math.round(status.coordination_score) + '%';
            document.getElementById('coordinationScore').className = 
                'status-value ' + getScoreClass(status.coordination_score);
            
            document.getElementById('stabilityMargin').textContent = 
                Math.round(status.stability_margin * 10) / 10 + 'mm';
            document.getElementById('stabilityMargin').className = 
                'status-value ' + (status.stability_margin > 10 ? 'status-good' : 
                                 status.stability_margin > 5 ? 'status-warning' : 'status-danger');
            
            document.getElementById('uptime').textContent = 
                Math.round(status.uptime) + 's';
        }
        
        function updateLegPositions(positions, velocities) {
            const legIds = ['RF', 'LF', 'LM', 'LB', 'RB', 'RM'];
            
            legIds.forEach(legId => {
                const pos = positions[legId] || [0, 0, 0];
                const vel = velocities[legId] || 0;
                
                const legIdLower = legId.toLowerCase();
                const posElement = document.getElementById(`${legIdLower}-position`);
                const velElement = document.getElementById(`${legIdLower}-velocity`);
                
                if (posElement) {
                    posElement.textContent = 
                        `位置: [${pos[0].toFixed(1)}, ${pos[1].toFixed(1)}, ${pos[2].toFixed(1)}]`;
                }
                
                if (velElement) {
                    velElement.textContent = `速度: ${vel.toFixed(1)} mm/s`;
                    velElement.className = 'leg-position ' + getVelocityClass(vel);
                }
            });
        }
        
        function updateCharts(trajectories, velocities) {
            // 3D軌道チャート
            const traces3d = [];
            const legColors = {
                'RF': '#dc3545', 'LF': '#007bff', 'LM': '#28a745',
                'LB': '#ffc107', 'RB': '#6f42c1', 'RM': '#fd7e14'
            };
            
            Object.keys(trajectories).forEach(legId => {
                const trajectory = trajectories[legId];
                if (trajectory.length > 0) {
                    const x = trajectory.map(p => p[0]);
                    const y = trajectory.map(p => p[1]);
                    const z = trajectory.map(p => p[2]);
                    
                    traces3d.push({
                        x: x, y: y, z: z,
                        type: 'scatter3d',
                        mode: 'lines+markers',
                        name: legId,
                        line: { color: legColors[legId], width: 3 },
                        marker: { size: 3 }
                    });
                }
            });
            
            const layout3d = {
                title: '3D足先軌道',
                scene: {
                    xaxis: { title: 'X (mm)', range: [50, 250] },
                    yaxis: { title: 'Y (mm)', range: [-100, 100] },
                    zaxis: { title: 'Z (mm)', range: [-150, -50] }
                },
                margin: { l: 0, r: 0, b: 0, t: 30 }
            };
            
            Plotly.newPlot('trajectory3d', traces3d, layout3d);
            
            // XY平面軌道チャート
            const tracesXY = [];
            Object.keys(trajectories).forEach(legId => {
                const trajectory = trajectories[legId];
                if (trajectory.length > 0) {
                    const x = trajectory.map(p => p[0]);
                    const y = trajectory.map(p => p[1]);
                    
                    tracesXY.push({
                        x: x, y: y,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: legId,
                        line: { color: legColors[legId], width: 3 },
                        marker: { size: 4 }
                    });
                }
            });
            
            const layoutXY = {
                title: 'XY平面軌道',
                xaxis: { title: 'X (mm)', range: [50, 250] },
                yaxis: { title: 'Y (mm)', range: [-100, 100] },
                margin: { l: 40, r: 10, b: 40, t: 30 }
            };
            
            Plotly.newPlot('trajectoryXY', tracesXY, layoutXY);
            
            // 速度チャート
            const velocityTraces = [];
            Object.keys(velocities).forEach(legId => {
                velocityTraces.push({
                    y: [velocities[legId]],
                    type: 'bar',
                    name: legId,
                    marker: { color: legColors[legId] }
                });
            });
            
            const velocityLayout = {
                title: '現在の足先速度',
                yaxis: { title: '速度 (mm/s)' },
                margin: { l: 40, r: 10, b: 40, t: 30 }
            };
            
            Plotly.newPlot('velocityChart', velocityTraces, velocityLayout);
        }
        
        function updateMetrics(metrics) {
            if (!metrics || !metrics.metrics) return;
            
            const m = metrics.metrics;
            const traces = [{
                x: ['協調性', '安定性', '規則性', '効率', '一貫性'],
                y: [
                    m.coordination_score || 0,
                    (m.stability_margin || 0) * 10, // mm → %変換
                    m.step_regularity || 0,
                    m.gait_efficiency || 0,
                    m.phase_consistency || 0
                ],
                type: 'bar',
                marker: {
                    color: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1']
                }
            }];
            
            const layout = {
                title: '歩行メトリクス',
                yaxis: { title: 'スコア (%)', range: [0, 100] },
                margin: { l: 40, r: 10, b: 40, t: 30 }
            };
            
            Plotly.newPlot('metricsChart', traces, layout);
        }
        
        function getScoreClass(score) {
            if (score >= 70) return 'status-good';
            if (score >= 50) return 'status-warning';
            return 'status-danger';
        }
        
        function getVelocityClass(velocity) {
            if (velocity > 150) return 'status-danger';
            if (velocity > 100) return 'status-warning';
            return 'status-good';
        }
        
        // 初期チャートの設定
        document.addEventListener('DOMContentLoaded', function() {
            // 空のチャートで初期化
            Plotly.newPlot('trajectory3d', [], {
                title: '3D足先軌道',
                scene: {
                    xaxis: { title: 'X (mm)' },
                    yaxis: { title: 'Y (mm)' },
                    zaxis: { title: 'Z (mm)' }
                }
            });
            
            Plotly.newPlot('trajectoryXY', [], {
                title: 'XY平面軌道',
                xaxis: { title: 'X (mm)' },
                yaxis: { title: 'Y (mm)' }
            });
            
            Plotly.newPlot('velocityChart', [], {
                title: '足先速度',
                yaxis: { title: '速度 (mm/s)' }
            });
            
            Plotly.newPlot('metricsChart', [], {
                title: '歩行メトリクス',
                yaxis: { title: 'スコア (%)' }
            });
        });
    </script>
</body>
</html>
