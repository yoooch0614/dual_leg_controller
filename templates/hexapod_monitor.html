<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6è„šãƒ­ãƒœãƒƒãƒˆè¶³å…ˆå‹•ä½œç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .status-card h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .status-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 15px 0;
            transition: color 0.3s ease;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .chart-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-panel h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        
        .leg-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .leg-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .leg-card:hover {
            transform: translateY(-3px);
        }
        
        .leg-card h4 {
            margin-bottom: 15px;
            font-size: 1.2em;
            text-align: center;
        }
        
        .leg-position {
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .status-info { color: #17a2b8; }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .connected { 
            background: linear-gradient(45deg, #28a745, #20c997);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .disconnected { 
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        
        .console-panel {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .console-header {
            background: linear-gradient(45deg, #333, #555);
            color: white;
            padding: 15px 25px;
            font-weight: bold;
        }
        
        .console-output {
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            height: 250px;
            overflow-y: auto;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .console-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .console-output::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .console-output::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 0, 0.3);
            border-radius: 4px;
        }
        
        .time-display {
            font-size: 1.2em;
            color: #666;
            margin-top: 10px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .plot-container {
            height: 350px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .status-panel {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦¾ 6è„šãƒ­ãƒœãƒƒãƒˆè¶³å…ˆå‹•ä½œç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¶³å…ˆä½ç½®ãƒ»æ­©è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®ç·åˆç›£è¦–</p>
            <div id="currentTime" class="time-display"></div>
        </div>
        
        <div id="connectionStatus" class="connection-status disconnected">
            ğŸ”´ ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šä¸­...
        </div>
        
        <div class="status-panel">
            <div class="status-card">
                <h3>ğŸ¤– æ­©è¡ŒçŠ¶æ…‹</h3>
                <div id="walkingStatus" class="status-value status-warning">å¾…æ©Ÿä¸­</div>
            </div>
            <div class="status-card">
                <h3>ğŸ¯ æ­©è¡Œå”èª¿æ€§</h3>
                <div id="coordinationScore" class="status-value status-info">0%</div>
            </div>
            <div class="status-card">
                <h3>âš–ï¸ å®‰å®šä½™è£•</h3>
                <div id="stabilityMargin" class="status-value status-info">0.0mm</div>
            </div>
            <div class="status-card">
                <h3>â±ï¸ ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒæ™‚é–“</h3>
                <div id="uptime" class="status-value status-info">0s</div>
            </div>
            <div class="status-card">
                <h3>ğŸš¨ ç•°å¸¸æ¤œå‡ºä»¶æ•°</h3>
                <div id="anomalyCount" class="status-value status-good">0</div>
            </div>
            <div class="status-card">
                <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ª</h3>
                <div id="dataQuality" class="status-value status-good">è‰¯å¥½</div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-panel">
                <h3>ğŸ“ ç¾åœ¨ã®è¶³å…ˆä½ç½®ï¼ˆXYå¹³é¢å›³ï¼‰</h3>
                <div id="currentPositionsXY" class="plot-container"></div>
            </div>
            <div class="chart-panel">
                <h3>ğŸ“Š è¶³å…ˆé«˜ã•åˆ†å¸ƒï¼ˆZåº§æ¨™ï¼‰</h3>
                <div id="heightChart" class="plot-container"></div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-panel">
                <h3>ğŸƒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¶³å…ˆé€Ÿåº¦</h3>
                <div id="velocityChart" class="plot-container"></div>
            </div>
            <div class="chart-panel">
                <h3>ğŸ“ˆ æ­©è¡Œå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹</h3>
                <div id="metricsChart" class="plot-container"></div>
            </div>
        </div>
        
        <div class="leg-status">
            <div class="leg-card">
                <h4 style="color: #dc3545;">ğŸ¦µ RF - å³å‰è„š</h4>
                <div id="rf-position" class="leg-position">ä½ç½®: [140.0, 0.0, -90.0] mm</div>
                <div id="rf-velocity" class="leg-position">é€Ÿåº¦: 0.0 mm/s</div>
                <div id="rf-phase" class="leg-position">æ­©è¡Œä½ç›¸: å¾…æ©Ÿä¸­</div>
                <div id="rf-status" class="leg-position">çŠ¶æ…‹: æ­£å¸¸</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #007bff;">ğŸ¦µ LF - å·¦å‰è„š</h4>
                <div id="lf-position" class="leg-position">ä½ç½®: [140.0, 0.0, -90.0] mm</div>
                <div id="lf-velocity" class="leg-position">é€Ÿåº¦: 0.0 mm/s</div>
                <div id="lf-phase" class="leg-position">æ­©è¡Œä½ç›¸: å¾…æ©Ÿä¸­</div>
                <div id="lf-status" class="leg-position">çŠ¶æ…‹: æ­£å¸¸</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #28a745;">ğŸ¦µ LM - å·¦ä¸­è„š</h4>
                <div id="lm-position" class="leg-position">ä½ç½®: [140.0, 0.0, -90.0] mm</div>
                <div id="lm-velocity" class="leg-position">é€Ÿåº¦: 0.0 mm/s</div>
                <div id="lm-phase" class="leg-position">æ­©è¡Œä½ç›¸: å¾…æ©Ÿä¸­</div>
                <div id="lm-status" class="leg-position">çŠ¶æ…‹: æ­£å¸¸</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #ffc107;">ğŸ¦µ LB - å·¦å¾Œè„š</h4>
                <div id="lb-position" class="leg-position">ä½ç½®: [140.0, 0.0, -90.0] mm</div>
                <div id="lb-velocity" class="leg-position">é€Ÿåº¦: 0.0 mm/s</div>
                <div id="lb-phase" class="leg-position">æ­©è¡Œä½ç›¸: å¾…æ©Ÿä¸­</div>
                <div id="lb-status" class="leg-position">çŠ¶æ…‹: æ­£å¸¸</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #6f42c1;">ğŸ¦µ RB - å³å¾Œè„š</h4>
                <div id="rb-position" class="leg-position">ä½ç½®: [140.0, 0.0, -90.0] mm</div>
                <div id="rb-velocity" class="leg-position">é€Ÿåº¦: 0.0 mm/s</div>
                <div id="rb-phase" class="leg-position">æ­©è¡Œä½ç›¸: å¾…æ©Ÿä¸­</div>
                <div id="rb-status" class="leg-position">çŠ¶æ…‹: æ­£å¸¸</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #fd7e14;">ğŸ¦µ RM - å³ä¸­è„š</h4>
                <div id="rm-position" class="leg-position">ä½ç½®: [140.0, 0.0, -90.0] mm</div>
                <div id="rm-velocity" class="leg-position">é€Ÿåº¦: 0.0 mm/s</div>
                <div id="rm-phase" class="leg-position">æ­©è¡Œä½ç›¸: å¾…æ©Ÿä¸­</div>
                <div id="rm-status" class="leg-position">çŠ¶æ…‹: æ­£å¸¸</div>
            </div>
        </div>
        
        <div class="console-panel">
            <div class="console-header">
                ğŸ’» ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°
            </div>
            <div id="consoleOutput" class="console-output">
                <div>[èµ·å‹•] ğŸ¦¾ 6è„šãƒ­ãƒœãƒƒãƒˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</div>
                <div>[æ¥ç¶š] ğŸ“¡ ROSãƒˆãƒ”ãƒƒã‚¯æ¥ç¶šã‚’ç¢ºèªä¸­...</div>
                <div>[æº–å‚™] âœ… Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æº–å‚™å®Œäº†</div>
                <div>[å¾…æ©Ÿ] ğŸ”„ ãƒ­ãƒœãƒƒãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾…æ©Ÿä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let socket = null;
        let isConnected = false;
        let demoMode = false;
        let updateCounter = 0;
        
        // è„šã®è‰²è¨­å®š
        const legColors = {
            'RF': '#dc3545', 'LF': '#007bff', 'LM': '#28a745',
            'LB': '#ffc107', 'RB': '#6f42c1', 'RM': '#fd7e14'
        };
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addConsoleMessage('ğŸš€ Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†');
            initializeConnection();
            startTimeUpdater();
            initializeCharts();
        });
        
        function initializeConnection() {
            try {
                // Socket.IOæ¥ç¶šã‚’è©¦è¡Œ
                socket = io();
                
                socket.on('connect', function() {
                    isConnected = true;
                    updateConnectionStatus(true);
                    addConsoleMessage('âœ… ROSã‚·ã‚¹ãƒ†ãƒ ã«æ­£å¸¸æ¥ç¶šã—ã¾ã—ãŸ');
                });
                
                socket.on('disconnect', function() {
                    isConnected = false;
                    updateConnectionStatus(false);
                    addConsoleMessage('âŒ ROSã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
                });
                
                socket.on('data_update', function(data) {
                    updateAllData(data);
                });
                
                // æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
                setTimeout(function() {
                    if (!isConnected) {
                        addConsoleMessage('âš ï¸ ROSæ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™');
                        startDemoMode();
                    }
                }, 3000);
                
            } catch (error) {
                addConsoleMessage('âš ï¸ Socket.IOåˆ©ç”¨ä¸å¯ - ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™');
                startDemoMode();
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = 'ğŸŸ¢ ROSæ¥ç¶šä¸­';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = 'ğŸ”´ ROSåˆ‡æ–­';
            }
        }
        
        function startDemoMode() {
            demoMode = true;
            updateConnectionStatus(false);
            document.getElementById('connectionStatus').innerHTML = 'ğŸŸ¡ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰';
            document.getElementById('connectionStatus').className = 'connection-status' + ' ' + 'status-warning';
            
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§å®šæœŸæ›´æ–°
            setInterval(function() {
                const demoData = generateDemoData();
                updateAllData(demoData);
            }, 500);
        }
        
        function generateDemoData() {
            const time = Date.now() / 1000;
            const legIds = ['RF', 'LF', 'LM', 'LB', 'RB', 'RM'];
            const positions = {};
            const velocities = {};
            
            legIds.forEach((legId, index) => {
                const phase = (time * 0.5 + index * 0.5) % 2;
                const walkingPhase = Math.sin(time * 0.8 + index * Math.PI / 3);
                
                const x = 140 + 30 * Math.sin(time * 0.3 + index);
                const y = 15 * Math.cos(time * 0.4 + index * 0.8);
                const z = -90 + (phase < 1 ? 15 * Math.abs(Math.sin(time * 1.5 + index)) : 0);
                
                positions[legId] = [x, y, z];
                velocities[legId] = 30 + 20 * Math.abs(Math.sin(time + index));
            });
            
            return {
                system_status: {
                    is_walking: true,
                    coordination_score: 80 + 15 * Math.sin(time * 0.1),
                    stability_margin: 7 + 3 * Math.cos(time * 0.15),
                    uptime: (time % 3600),
                    anomaly_count: Math.floor(Math.random() * 2),
                    data_quality: 'ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿'
                },
                positions: positions,
                velocities: velocities,
                metrics: {
                    coordination_score: 82 + 10 * Math.sin(time * 0.05),
                    stability_margin: 8.5,
                    step_regularity: 76 + 8 * Math.cos(time * 0.08),
                    gait_efficiency: 78 + 5 * Math.sin(time * 0.12),
                    phase_consistency: 85
                }
            };
        }
        
        function updateAllData(data) {
            updateCounter++;
            
            if (data.system_status) {
                updateStatusPanel(data.system_status);
            }
            
            if (data.positions && data.velocities) {
                updateLegData(data.positions, data.velocities);
                updateCharts(data.positions, data.velocities);
            }
            
            if (data.metrics) {
                updateMetricsChart(data.metrics);
            }
            
            // å®šæœŸçš„ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            if (updateCounter % 20 === 0) {
                const message = demoMode ? 
                    `ğŸ“Š ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿æ›´æ–° (${updateCounter}å›ç›®)` :
                    `ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿å—ä¿¡ (${updateCounter}å›ç›®)`;
                addConsoleMessage(message);
            }
        }
        
        function updateStatusPanel(status) {
            // æ­©è¡ŒçŠ¶æ…‹
            const walkingElement = document.getElementById('walkingStatus');
            walkingElement.textContent = status.is_walking ? 'æ­©è¡Œä¸­' : 'å¾…æ©Ÿä¸­';
            walkingElement.className = 'status-value ' + (status.is_walking ? 'status-good pulse' : 'status-warning');
            
            // å”èª¿æ€§ã‚¹ã‚³ã‚¢
            const coordElement = document.getElementById('coordinationScore');
            const coordScore = Math.round(status.coordination_score || 0);
            coordElement.textContent = coordScore + '%';
            coordElement.className = 'status-value ' + getScoreClass(coordScore);
            
            // å®‰å®šä½™è£•
            const stabilityElement = document.getElementById('stabilityMargin');
            const stabilityValue = (status.stability_margin || 0).toFixed(1);
            stabilityElement.textContent = stabilityValue + 'mm';
            stabilityElement.className = 'status-value ' + getStabilityClass(parseFloat(stabilityValue));
            
            // ç¨¼åƒæ™‚é–“
            document.getElementById('uptime').textContent = formatUptime(status.uptime || 0);
            
            // ç•°å¸¸ä»¶æ•°
            const anomalyElement = document.getElementById('anomalyCount');
            anomalyElement.textContent = status.anomaly_count || 0;
            anomalyElement.className = 'status-value ' + (status.anomaly_count > 0 ? 'status-danger' : 'status-good');
            
            // ãƒ‡ãƒ¼ã‚¿å“è³ª
            document.getElementById('dataQuality').textContent = status.data_quality || 'è‰¯å¥½';
        }
        
        function updateLegData(positions, velocities) {
            const legIds = ['RF', 'LF', 'LM', 'LB', 'RB', 'RM'];
            
            legIds.forEach(legId => {
                const pos = positions[legId] || [140, 0, -90];
                const vel = velocities[legId] || 0;
                
                const legIdLower = legId.toLowerCase();
                
                // ä½ç½®æ›´æ–°
                const posElement = document.getElementById(`${legIdLower}-position`);
                if (posElement) {
                    posElement.textContent = `ä½ç½®: [${pos[0].toFixed(1)}, ${pos[1].toFixed(1)}, ${pos[2].toFixed(1)}] mm`;
                }
                
                // é€Ÿåº¦æ›´æ–°
                const velElement = document.getElementById(`${legIdLower}-velocity`);
                if (velElement) {
                    velElement.textContent = `é€Ÿåº¦: ${vel.toFixed(1)} mm/s`;
                    velElement.className = 'leg-position ' + getVelocityClass(vel);
                }
                
                // æ­©è¡Œä½ç›¸æ›´æ–°
                const phaseElement = document.getElementById(`${legIdLower}-phase`);
                if (phaseElement) {
                    const phase = pos[2] > -85 ? 'ã‚¹ã‚¤ãƒ³ã‚°æœŸ' : 'ã‚¹ã‚¿ãƒ³ã‚¹æœŸ';
                    phaseElement.textContent = `æ­©è¡Œä½ç›¸: ${phase}`;
                    phaseElement.className = 'leg-position ' + (phase === 'ã‚¹ã‚¤ãƒ³ã‚°æœŸ' ? 'status-warning' : 'status-good');
                }
                
                // çŠ¶æ…‹æ›´æ–°
                const statusElement = document.getElementById(`${legIdLower}-status`);
                if (statusElement) {
                    const status = getlegStatus(pos, vel);
                    statusElement.textContent = `çŠ¶æ…‹: ${status.text}`;
                    statusElement.className = 'leg-position ' + status.class;
                }
            });
        }
        
        function updateCharts(positions, velocities) {
            updatePositionChart(positions);
            updateHeightChart(positions);
            updateVelocityChart(velocities);
        }
        
        function updatePositionChart(positions) {
            const traces = [];
            const robotBodyX = [];
            const robotBodyY = [];
            
            // ãƒ­ãƒœãƒƒãƒˆæœ¬ä½“ã®å…­è§’å½¢ã‚’æç”»
            for (let i = 0; i <= 6; i++) {
                const angle = (i * 60) * Math.PI / 180;
                robotBodyX.push(95 * Math.cos(angle));
                robotBodyY.push(95 * Math.sin(angle));
            }
            
            traces.push({
                x: robotBodyX,
                y: robotBodyY,
                type: 'scatter',
                mode: 'lines',
                name: 'ãƒ­ãƒœãƒƒãƒˆæœ¬ä½“',
                line: { color: '#333', width: 3 },
                showlegend: true
            });
            
            // å„è„šã®ä½ç½®ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
            Object.keys(positions).forEach(legId => {
                const pos = positions[legId];
                const isSwing = pos[2] > -85;
                
                traces.push({
                    x: [pos[0]],
                    y: [pos[1]],
                    type: 'scatter',
                    mode: 'markers',
                    name: legId,
                    marker: {
                        color: legColors[legId],
                        size: 12,
                        symbol: isSwing ? 'triangle-up' : 'circle',
                        line: { color: '#333', width: 1 }
                    }
                });
            });
            
            const layout = {
                title: {
                    text: 'è¶³å…ˆä½ç½®ï¼ˆä¸Šé¢å›³ï¼‰',
                    font: { size: 16 }
                },
                xaxis: { 
                    title: 'Xåº§æ¨™ (mm)', 
                    range: [50, 250],
                    gridcolor: '#eee'
                },
                yaxis: { 
                    title: 'Yåº§æ¨™ (mm)', 
                    range: [-120, 120],
                    scaleanchor: "x",
                    scaleratio: 1,
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 50, r: 20, b: 50, t: 50 },
                legend: { orientation: 'h', y: -0.1 }
            };
            
            Plotly.newPlot('currentPositionsXY', traces, layout, {responsive: true});
        }
        
        function updateHeightChart(positions) {
            const legIds = Object.keys(positions);
            const heights = legIds.map(legId => positions[legId][2]);
            
            const traces = [{
                x: legIds,
                y: heights,
                type: 'bar',
                marker: {
                    color: legIds.map(legId => legColors[legId]),
                    line: { color: '#333', width: 1 }
                },
                text: heights.map(h => h.toFixed(1)),
                textposition: 'auto'
            }];
            
            const layout = {
                title: {
                    text: 'è¶³å…ˆé«˜ã•åˆ†å¸ƒ',
                    font: { size: 16 }
                },
                xaxis: { title: 'è„šID' },
                yaxis: { 
                    title: 'Zåº§æ¨™ (mm)', 
                    range: [-130, -40],
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 50, r: 20, b: 50, t: 50 }
            };
            
            Plotly.newPlot('heightChart', traces, layout, {responsive: true});
        }
        
        function updateVelocityChart(velocities) {
            const legIds = Object.keys(velocities);
            const vels = legIds.map(legId => velocities[legId]);
            
            const traces = [{
                x: legIds,
                y: vels,
                type: 'bar',
                marker: {
                    color: legIds.map(legId => legColors[legId]),
                    line: { color: '#333', width: 1 }
                },
                text: vels.map(v => v.toFixed(1)),
                textposition: 'auto'
            }];
            
            const layout = {
                title: {
                    text: 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¶³å…ˆé€Ÿåº¦',
                    font: { size: 16 }
                },
                xaxis: { title: 'è„šID' },
                yaxis: { 
                    title: 'é€Ÿåº¦ (mm/s)', 
                    range: [0, Math.max(100, Math.max(...vels) * 1.2)],
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 50, r: 20, b: 50, t: 50 }
            };
            
            Plotly.newPlot('velocityChart', traces, layout, {responsive: true});
        }
        
        function updateMetricsChart(metrics) {
            const metricNames = ['å”èª¿æ€§', 'å®‰å®šæ€§', 'è¦å‰‡æ€§', 'åŠ¹ç‡', 'ä¸€è²«æ€§'];
            const metricValues = [
                metrics.coordination_score || 0,
                (metrics.stability_margin || 0) * 10, // mm â†’ %å¤‰æ›
                metrics.step_regularity || 0,
                metrics.gait_efficiency || 0,
                metrics.phase_consistency || 0
            ];
            
            const traces = [{
                x: metricNames,
                y: metricValues,
                type: 'bar',
                marker: {
                    color: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'],
                    line: { color: '#333', width: 1 }
                },
                text: metricValues.map(v => v.toFixed(1) + '%'),
                textposition: 'auto'
            }];
            
            const layout = {
                title: {
                    text: 'æ­©è¡Œå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹',
                    font: { size: 16 }
                },
                xaxis: { title: 'ãƒ¡ãƒˆãƒªã‚¯ã‚¹' },
                yaxis: { 
                    title: 'ã‚¹ã‚³ã‚¢ (%)', 
                    range: [0, 100],
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 50, r: 20, b: 50, t: 50 }
            };
            
            Plotly.newPlot('metricsChart', traces, layout, {responsive: true});
        }
        
        function initializeCharts() {
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã§ãƒãƒ£ãƒ¼ãƒˆã‚’åˆæœŸåŒ–
            const initialPositions = {
                RF: [140, 0, -90], LF: [140, 0, -90], LM: [140, 0, -90],
                LB: [140, 0, -90], RB: [140, 0, -90], RM: [140, 0, -90]
            };
            const initialVelocities = {
                RF: 0, LF: 0, LM: 0, LB: 0, RB: 0, RM: 0
            };
            const initialMetrics = {
                coordination_score: 0,
                stability_margin: 0,
                step_regularity: 0,
                gait_efficiency: 0,
                phase_consistency: 0
            };
            
            updateCharts(initialPositions, initialVelocities);
            updateMetricsChart(initialMetrics);
            
            addConsoleMessage('ğŸ“Š ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–å®Œäº†');
        }
        
        function startTimeUpdater() {
            setInterval(function() {
                const now = new Date();
                document.getElementById('currentTime').textContent = 
                    'ç¾åœ¨æ™‚åˆ»: ' + now.toLocaleString('ja-JP');
            }, 1000);
        }
        
        function addConsoleMessage(message) {
            const console = document.getElementById('consoleOutput');
            const time = new Date().toLocaleTimeString('ja-JP');
            const div = document.createElement('div');
            div.innerHTML = `<span style="color: #888;">[${time}]</span> ${message}`;
            console.appendChild(div);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
            console.scrollTop = console.scrollHeight;
            
            // å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆ100è¡Œã‚’è¶…ãˆãŸå ´åˆï¼‰
            const messages = console.children;
            if (messages.length > 100) {
                console.removeChild(messages[0]);
            }
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getScoreClass(score) {
            if (score >= 80) return 'status-good';
            if (score >= 60) return 'status-warning';
            return 'status-danger';
        }
        
        function getStabilityClass(stability) {
            if (stability >= 8.0) return 'status-good';
            if (stability >= 5.0) return 'status-warning';
            return 'status-danger';
        }
        
        function getVelocityClass(velocity) {
            if (velocity > 150) return 'status-danger';
            if (velocity > 100) return 'status-warning';
            if (velocity > 50) return 'status-info';
            return 'status-good';
        }
        
        function getlegStatus(position, velocity) {
            const x = position[0], y = position[1], z = position[2];
            
            // ä½ç½®ãƒã‚§ãƒƒã‚¯
            if (x < 80 || x > 220 || y < -80 || y > 80 || z < -130 || z > -40) {
                return { text: 'ä½ç½®ç•°å¸¸', class: 'status-danger' };
            }
            
            // é€Ÿåº¦ãƒã‚§ãƒƒã‚¯
            if (velocity > 150) {
                return { text: 'é«˜é€Ÿç§»å‹•', class: 'status-warning' };
            }
            
            // æ­£å¸¸
            if (velocity > 10) {
                return { text: 'å‹•ä½œä¸­', class: 'status-info' };
            } else {
                return { text: 'æ­£å¸¸', class: 'status-good' };
            }
        }
        
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }
        
        // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆSocket.IOæœªä½¿ç”¨æ™‚ï¼‰
        function fetchDataPeriodically() {
            setInterval(async function() {
                if (!isConnected && !demoMode) {
                    try {
                        const [statusResponse, positionsResponse, velocitiesResponse, metricsResponse] = await Promise.all([
                            fetch('/api/status'),
                            fetch('/api/positions'),
                            fetch('/api/velocities'),
                            fetch('/api/metrics')
                        ]);
                        
                        const status = await statusResponse.json();
                        const positions = await positionsResponse.json();
                        const velocities = await velocitiesResponse.json();
                        const metrics = await metricsResponse.json();
                        
                        updateAllData({
                            system_status: status,
                            positions: positions,
                            velocities: velocities,
                            metrics: metrics
                        });
                        
                        if (!isConnected) {
                            document.getElementById('connectionStatus').innerHTML = 'ğŸŸ¢ HTTPæ¥ç¶š';
                            document.getElementById('connectionStatus').className = 'connection-status connected';
                        }
                        
                    } catch (error) {
                        if (!demoMode) {
                            addConsoleMessage('âš ï¸ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ - ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
                            startDemoMode();
                        }
                    }
                }
            }, 1000);
        }
        
        // HTTP APIã«ã‚ˆã‚‹å®šæœŸå–å¾—ã‚‚é–‹å§‹
        setTimeout(fetchDataPeriodically, 5000);
        
        // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
        });
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
        window.addEventListener('resize', function() {
            // ãƒãƒ£ãƒ¼ãƒˆã®ãƒªã‚µã‚¤ã‚º
            const chartIds = ['currentPositionsXY', 'heightChart', 'velocityChart', 'metricsChart'];
            chartIds.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.data) {
                    Plotly.Plots.resize(element);
                }
            });
        });
        
        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        setTimeout(function() {
            if (demoMode) {
                addConsoleMessage('ğŸ¯ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­ - æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™');
            } else if (isConnected) {
                addConsoleMessage('ğŸ¯ ROSã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶šæ¸ˆã¿ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ä¸­');
            } else {
                addConsoleMessage('ğŸ”„ ROSã‚·ã‚¹ãƒ†ãƒ ã¸ã®æ¥ç¶šã‚’è©¦è¡Œä¸­...');
            }
        }, 1000);
        
    </script>
</body>
</html>