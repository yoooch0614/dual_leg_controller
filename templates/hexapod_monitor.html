<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6脚ロボット足先動作監視システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .status-card h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .status-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 15px 0;
            transition: color 0.3s ease;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .chart-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-panel h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        
        .leg-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .leg-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .leg-card:hover {
            transform: translateY(-3px);
        }
        
        .leg-card h4 {
            margin-bottom: 15px;
            font-size: 1.2em;
            text-align: center;
        }
        
        .leg-position {
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .status-info { color: #17a2b8; }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .connected { 
            background: linear-gradient(45deg, #28a745, #20c997);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .disconnected { 
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        
        .console-panel {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .console-header {
            background: linear-gradient(45deg, #333, #555);
            color: white;
            padding: 15px 25px;
            font-weight: bold;
        }
        
        .console-output {
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            height: 250px;
            overflow-y: auto;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .console-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .console-output::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .console-output::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 0, 0.3);
            border-radius: 4px;
        }
        
        .time-display {
            font-size: 1.2em;
            color: #666;
            margin-top: 10px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .plot-container {
            height: 350px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .status-panel {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🦾 6脚ロボット足先動作監視システム</h1>
            <p>リアルタイム足先位置・歩行パターン・システム状態の総合監視</p>
            <div id="currentTime" class="time-display"></div>
        </div>
        
        <div id="connectionStatus" class="connection-status disconnected">
            🔴 システム接続中...
        </div>
        
        <div class="status-panel">
            <div class="status-card">
                <h3>🤖 歩行状態</h3>
                <div id="walkingStatus" class="status-value status-warning">待機中</div>
            </div>
            <div class="status-card">
                <h3>🎯 歩行協調性</h3>
                <div id="coordinationScore" class="status-value status-info">0%</div>
            </div>
            <div class="status-card">
                <h3>⚖️ 安定余裕</h3>
                <div id="stabilityMargin" class="status-value status-info">0.0mm</div>
            </div>
            <div class="status-card">
                <h3>⏱️ システム稼働時間</h3>
                <div id="uptime" class="status-value status-info">0s</div>
            </div>
            <div class="status-card">
                <h3>🚨 異常検出件数</h3>
                <div id="anomalyCount" class="status-value status-good">0</div>
            </div>
            <div class="status-card">
                <h3>📊 データ品質</h3>
                <div id="dataQuality" class="status-value status-good">良好</div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-panel">
                <h3>📍 現在の足先位置（XY平面図）</h3>
                <div id="currentPositionsXY" class="plot-container"></div>
            </div>
            <div class="chart-panel">
                <h3>📊 足先高さ分布（Z座標）</h3>
                <div id="heightChart" class="plot-container"></div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-panel">
                <h3>🏃 リアルタイム足先速度</h3>
                <div id="velocityChart" class="plot-container"></div>
            </div>
            <div class="chart-panel">
                <h3>📈 歩行品質メトリクス</h3>
                <div id="metricsChart" class="plot-container"></div>
            </div>
        </div>
        
        <div class="leg-status">
            <div class="leg-card">
                <h4 style="color: #dc3545;">🦵 RF - 右前脚</h4>
                <div id="rf-position" class="leg-position">位置: [140.0, 0.0, -90.0] mm</div>
                <div id="rf-velocity" class="leg-position">速度: 0.0 mm/s</div>
                <div id="rf-phase" class="leg-position">歩行位相: 待機中</div>
                <div id="rf-status" class="leg-position">状態: 正常</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #007bff;">🦵 LF - 左前脚</h4>
                <div id="lf-position" class="leg-position">位置: [140.0, 0.0, -90.0] mm</div>
                <div id="lf-velocity" class="leg-position">速度: 0.0 mm/s</div>
                <div id="lf-phase" class="leg-position">歩行位相: 待機中</div>
                <div id="lf-status" class="leg-position">状態: 正常</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #28a745;">🦵 LM - 左中脚</h4>
                <div id="lm-position" class="leg-position">位置: [140.0, 0.0, -90.0] mm</div>
                <div id="lm-velocity" class="leg-position">速度: 0.0 mm/s</div>
                <div id="lm-phase" class="leg-position">歩行位相: 待機中</div>
                <div id="lm-status" class="leg-position">状態: 正常</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #ffc107;">🦵 LB - 左後脚</h4>
                <div id="lb-position" class="leg-position">位置: [140.0, 0.0, -90.0] mm</div>
                <div id="lb-velocity" class="leg-position">速度: 0.0 mm/s</div>
                <div id="lb-phase" class="leg-position">歩行位相: 待機中</div>
                <div id="lb-status" class="leg-position">状態: 正常</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #6f42c1;">🦵 RB - 右後脚</h4>
                <div id="rb-position" class="leg-position">位置: [140.0, 0.0, -90.0] mm</div>
                <div id="rb-velocity" class="leg-position">速度: 0.0 mm/s</div>
                <div id="rb-phase" class="leg-position">歩行位相: 待機中</div>
                <div id="rb-status" class="leg-position">状態: 正常</div>
            </div>
            <div class="leg-card">
                <h4 style="color: #fd7e14;">🦵 RM - 右中脚</h4>
                <div id="rm-position" class="leg-position">位置: [140.0, 0.0, -90.0] mm</div>
                <div id="rm-velocity" class="leg-position">速度: 0.0 mm/s</div>
                <div id="rm-phase" class="leg-position">歩行位相: 待機中</div>
                <div id="rm-status" class="leg-position">状態: 正常</div>
            </div>
        </div>
        
        <div class="console-panel">
            <div class="console-header">
                💻 システムコンソール - リアルタイムログ
            </div>
            <div id="consoleOutput" class="console-output">
                <div>[起動] 🦾 6脚ロボット監視システム初期化中...</div>
                <div>[接続] 📡 ROSトピック接続を確認中...</div>
                <div>[準備] ✅ Webインターフェース準備完了</div>
                <div>[待機] 🔄 ロボットからのデータを待機中...</div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let socket = null;
        let isConnected = false;
        let demoMode = false;
        let updateCounter = 0;
        
        // 脚の色設定
        const legColors = {
            'RF': '#dc3545', 'LF': '#007bff', 'LM': '#28a745',
            'LB': '#ffc107', 'RB': '#6f42c1', 'RM': '#fd7e14'
        };
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            addConsoleMessage('🚀 Webインターフェース初期化完了');
            initializeConnection();
            startTimeUpdater();
            initializeCharts();
        });
        
        function initializeConnection() {
            try {
                // Socket.IO接続を試行
                socket = io();
                
                socket.on('connect', function() {
                    isConnected = true;
                    updateConnectionStatus(true);
                    addConsoleMessage('✅ ROSシステムに正常接続しました');
                });
                
                socket.on('disconnect', function() {
                    isConnected = false;
                    updateConnectionStatus(false);
                    addConsoleMessage('❌ ROSシステムから切断されました');
                });
                
                socket.on('data_update', function(data) {
                    updateAllData(data);
                });
                
                // 接続タイムアウト処理
                setTimeout(function() {
                    if (!isConnected) {
                        addConsoleMessage('⚠️ ROS接続タイムアウト - デモモードで動作します');
                        startDemoMode();
                    }
                }, 3000);
                
            } catch (error) {
                addConsoleMessage('⚠️ Socket.IO利用不可 - デモモードで動作します');
                startDemoMode();
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = '🟢 ROS接続中';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = '🔴 ROS切断';
            }
        }
        
        function startDemoMode() {
            demoMode = true;
            updateConnectionStatus(false);
            document.getElementById('connectionStatus').innerHTML = '🟡 デモモード';
            document.getElementById('connectionStatus').className = 'connection-status' + ' ' + 'status-warning';
            
            // デモデータで定期更新
            setInterval(function() {
                const demoData = generateDemoData();
                updateAllData(demoData);
            }, 500);
        }
        
        function generateDemoData() {
            const time = Date.now() / 1000;
            const legIds = ['RF', 'LF', 'LM', 'LB', 'RB', 'RM'];
            const positions = {};
            const velocities = {};
            
            legIds.forEach((legId, index) => {
                const phase = (time * 0.5 + index * 0.5) % 2;
                const walkingPhase = Math.sin(time * 0.8 + index * Math.PI / 3);
                
                const x = 140 + 30 * Math.sin(time * 0.3 + index);
                const y = 15 * Math.cos(time * 0.4 + index * 0.8);
                const z = -90 + (phase < 1 ? 15 * Math.abs(Math.sin(time * 1.5 + index)) : 0);
                
                positions[legId] = [x, y, z];
                velocities[legId] = 30 + 20 * Math.abs(Math.sin(time + index));
            });
            
            return {
                system_status: {
                    is_walking: true,
                    coordination_score: 80 + 15 * Math.sin(time * 0.1),
                    stability_margin: 7 + 3 * Math.cos(time * 0.15),
                    uptime: (time % 3600),
                    anomaly_count: Math.floor(Math.random() * 2),
                    data_quality: 'デモデータ'
                },
                positions: positions,
                velocities: velocities,
                metrics: {
                    coordination_score: 82 + 10 * Math.sin(time * 0.05),
                    stability_margin: 8.5,
                    step_regularity: 76 + 8 * Math.cos(time * 0.08),
                    gait_efficiency: 78 + 5 * Math.sin(time * 0.12),
                    phase_consistency: 85
                }
            };
        }
        
        function updateAllData(data) {
            updateCounter++;
            
            if (data.system_status) {
                updateStatusPanel(data.system_status);
            }
            
            if (data.positions && data.velocities) {
                updateLegData(data.positions, data.velocities);
                updateCharts(data.positions, data.velocities);
            }
            
            if (data.metrics) {
                updateMetricsChart(data.metrics);
            }
            
            // 定期的にコンソールメッセージを追加
            if (updateCounter % 20 === 0) {
                const message = demoMode ? 
                    `📊 デモデータ更新 (${updateCounter}回目)` :
                    `📡 リアルタイムデータ受信 (${updateCounter}回目)`;
                addConsoleMessage(message);
            }
        }
        
        function updateStatusPanel(status) {
            // 歩行状態
            const walkingElement = document.getElementById('walkingStatus');
            walkingElement.textContent = status.is_walking ? '歩行中' : '待機中';
            walkingElement.className = 'status-value ' + (status.is_walking ? 'status-good pulse' : 'status-warning');
            
            // 協調性スコア
            const coordElement = document.getElementById('coordinationScore');
            const coordScore = Math.round(status.coordination_score || 0);
            coordElement.textContent = coordScore + '%';
            coordElement.className = 'status-value ' + getScoreClass(coordScore);
            
            // 安定余裕
            const stabilityElement = document.getElementById('stabilityMargin');
            const stabilityValue = (status.stability_margin || 0).toFixed(1);
            stabilityElement.textContent = stabilityValue + 'mm';
            stabilityElement.className = 'status-value ' + getStabilityClass(parseFloat(stabilityValue));
            
            // 稼働時間
            document.getElementById('uptime').textContent = formatUptime(status.uptime || 0);
            
            // 異常件数
            const anomalyElement = document.getElementById('anomalyCount');
            anomalyElement.textContent = status.anomaly_count || 0;
            anomalyElement.className = 'status-value ' + (status.anomaly_count > 0 ? 'status-danger' : 'status-good');
            
            // データ品質
            document.getElementById('dataQuality').textContent = status.data_quality || '良好';
        }
        
        function updateLegData(positions, velocities) {
            const legIds = ['RF', 'LF', 'LM', 'LB', 'RB', 'RM'];
            
            legIds.forEach(legId => {
                const pos = positions[legId] || [140, 0, -90];
                const vel = velocities[legId] || 0;
                
                const legIdLower = legId.toLowerCase();
                
                // 位置更新
                const posElement = document.getElementById(`${legIdLower}-position`);
                if (posElement) {
                    posElement.textContent = `位置: [${pos[0].toFixed(1)}, ${pos[1].toFixed(1)}, ${pos[2].toFixed(1)}] mm`;
                }
                
                // 速度更新
                const velElement = document.getElementById(`${legIdLower}-velocity`);
                if (velElement) {
                    velElement.textContent = `速度: ${vel.toFixed(1)} mm/s`;
                    velElement.className = 'leg-position ' + getVelocityClass(vel);
                }
                
                // 歩行位相更新
                const phaseElement = document.getElementById(`${legIdLower}-phase`);
                if (phaseElement) {
                    const phase = pos[2] > -85 ? 'スイング期' : 'スタンス期';
                    phaseElement.textContent = `歩行位相: ${phase}`;
                    phaseElement.className = 'leg-position ' + (phase === 'スイング期' ? 'status-warning' : 'status-good');
                }
                
                // 状態更新
                const statusElement = document.getElementById(`${legIdLower}-status`);
                if (statusElement) {
                    const status = getlegStatus(pos, vel);
                    statusElement.textContent = `状態: ${status.text}`;
                    statusElement.className = 'leg-position ' + status.class;
                }
            });
        }
        
        function updateCharts(positions, velocities) {
            updatePositionChart(positions);
            updateHeightChart(positions);
            updateVelocityChart(velocities);
        }
        
        function updatePositionChart(positions) {
            const traces = [];
            const robotBodyX = [];
            const robotBodyY = [];
            
            // ロボット本体の六角形を描画
            for (let i = 0; i <= 6; i++) {
                const angle = (i * 60) * Math.PI / 180;
                robotBodyX.push(95 * Math.cos(angle));
                robotBodyY.push(95 * Math.sin(angle));
            }
            
            traces.push({
                x: robotBodyX,
                y: robotBodyY,
                type: 'scatter',
                mode: 'lines',
                name: 'ロボット本体',
                line: { color: '#333', width: 3 },
                showlegend: true
            });
            
            // 各脚の位置をプロット
            Object.keys(positions).forEach(legId => {
                const pos = positions[legId];
                const isSwing = pos[2] > -85;
                
                traces.push({
                    x: [pos[0]],
                    y: [pos[1]],
                    type: 'scatter',
                    mode: 'markers',
                    name: legId,
                    marker: {
                        color: legColors[legId],
                        size: 12,
                        symbol: isSwing ? 'triangle-up' : 'circle',
                        line: { color: '#333', width: 1 }
                    }
                });
            });
            
            const layout = {
                title: {
                    text: '足先位置（上面図）',
                    font: { size: 16 }
                },
                xaxis: { 
                    title: 'X座標 (mm)', 
                    range: [50, 250],
                    gridcolor: '#eee'
                },
                yaxis: { 
                    title: 'Y座標 (mm)', 
                    range: [-120, 120],
                    scaleanchor: "x",
                    scaleratio: 1,
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 50, r: 20, b: 50, t: 50 },
                legend: { orientation: 'h', y: -0.1 }
            };
            
            Plotly.newPlot('currentPositionsXY', traces, layout, {responsive: true});
        }
        
        function updateHeightChart(positions) {
            const legIds = Object.keys(positions);
            const heights = legIds.map(legId => positions[legId][2]);
            
            const traces = [{
                x: legIds,
                y: heights,
                type: 'bar',
                marker: {
                    color: legIds.map(legId => legColors[legId]),
                    line: { color: '#333', width: 1 }
                },
                text: heights.map(h => h.toFixed(1)),
                textposition: 'auto'
            }];
            
            const layout = {
                title: {
                    text: '足先高さ分布',
                    font: { size: 16 }
                },
                xaxis: { title: '脚ID' },
                yaxis: { 
                    title: 'Z座標 (mm)', 
                    range: [-130, -40],
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 50, r: 20, b: 50, t: 50 }
            };
            
            Plotly.newPlot('heightChart', traces, layout, {responsive: true});
        }
        
        function updateVelocityChart(velocities) {
            const legIds = Object.keys(velocities);
            const vels = legIds.map(legId => velocities[legId]);
            
            const traces = [{
                x: legIds,
                y: vels,
                type: 'bar',
                marker: {
                    color: legIds.map(legId => legColors[legId]),
                    line: { color: '#333', width: 1 }
                },
                text: vels.map(v => v.toFixed(1)),
                textposition: 'auto'
            }];
            
            const layout = {
                title: {
                    text: 'リアルタイム足先速度',
                    font: { size: 16 }
                },
                xaxis: { title: '脚ID' },
                yaxis: { 
                    title: '速度 (mm/s)', 
                    range: [0, Math.max(100, Math.max(...vels) * 1.2)],
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 50, r: 20, b: 50, t: 50 }
            };
            
            Plotly.newPlot('velocityChart', traces, layout, {responsive: true});
        }
        
        function updateMetricsChart(metrics) {
            const metricNames = ['協調性', '安定性', '規則性', '効率', '一貫性'];
            const metricValues = [
                metrics.coordination_score || 0,
                (metrics.stability_margin || 0) * 10, // mm → %変換
                metrics.step_regularity || 0,
                metrics.gait_efficiency || 0,
                metrics.phase_consistency || 0
            ];
            
            const traces = [{
                x: metricNames,
                y: metricValues,
                type: 'bar',
                marker: {
                    color: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'],
                    line: { color: '#333', width: 1 }
                },
                text: metricValues.map(v => v.toFixed(1) + '%'),
                textposition: 'auto'
            }];
            
            const layout = {
                title: {
                    text: '歩行品質メトリクス',
                    font: { size: 16 }
                },
                xaxis: { title: 'メトリクス' },
                yaxis: { 
                    title: 'スコア (%)', 
                    range: [0, 100],
                    gridcolor: '#eee'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 50, r: 20, b: 50, t: 50 }
            };
            
            Plotly.newPlot('metricsChart', traces, layout, {responsive: true});
        }
        
        function initializeCharts() {
            // 初期データでチャートを初期化
            const initialPositions = {
                RF: [140, 0, -90], LF: [140, 0, -90], LM: [140, 0, -90],
                LB: [140, 0, -90], RB: [140, 0, -90], RM: [140, 0, -90]
            };
            const initialVelocities = {
                RF: 0, LF: 0, LM: 0, LB: 0, RB: 0, RM: 0
            };
            const initialMetrics = {
                coordination_score: 0,
                stability_margin: 0,
                step_regularity: 0,
                gait_efficiency: 0,
                phase_consistency: 0
            };
            
            updateCharts(initialPositions, initialVelocities);
            updateMetricsChart(initialMetrics);
            
            addConsoleMessage('📊 チャート初期化完了');
        }
        
        function startTimeUpdater() {
            setInterval(function() {
                const now = new Date();
                document.getElementById('currentTime').textContent = 
                    '現在時刻: ' + now.toLocaleString('ja-JP');
            }, 1000);
        }
        
        function addConsoleMessage(message) {
            const console = document.getElementById('consoleOutput');
            const time = new Date().toLocaleTimeString('ja-JP');
            const div = document.createElement('div');
            div.innerHTML = `<span style="color: #888;">[${time}]</span> ${message}`;
            console.appendChild(div);
            
            // スクロールを最下部に
            console.scrollTop = console.scrollHeight;
            
            // 古いメッセージを削除（100行を超えた場合）
            const messages = console.children;
            if (messages.length > 100) {
                console.removeChild(messages[0]);
            }
        }
        
        // ユーティリティ関数
        function getScoreClass(score) {
            if (score >= 80) return 'status-good';
            if (score >= 60) return 'status-warning';
            return 'status-danger';
        }
        
        function getStabilityClass(stability) {
            if (stability >= 8.0) return 'status-good';
            if (stability >= 5.0) return 'status-warning';
            return 'status-danger';
        }
        
        function getVelocityClass(velocity) {
            if (velocity > 150) return 'status-danger';
            if (velocity > 100) return 'status-warning';
            if (velocity > 50) return 'status-info';
            return 'status-good';
        }
        
        function getlegStatus(position, velocity) {
            const x = position[0], y = position[1], z = position[2];
            
            // 位置チェック
            if (x < 80 || x > 220 || y < -80 || y > 80 || z < -130 || z > -40) {
                return { text: '位置異常', class: 'status-danger' };
            }
            
            // 速度チェック
            if (velocity > 150) {
                return { text: '高速移動', class: 'status-warning' };
            }
            
            // 正常
            if (velocity > 10) {
                return { text: '動作中', class: 'status-info' };
            } else {
                return { text: '正常', class: 'status-good' };
            }
        }
        
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }
        
        // APIエンドポイントから定期的にデータを取得（Socket.IO未使用時）
        function fetchDataPeriodically() {
            setInterval(async function() {
                if (!isConnected && !demoMode) {
                    try {
                        const [statusResponse, positionsResponse, velocitiesResponse, metricsResponse] = await Promise.all([
                            fetch('/api/status'),
                            fetch('/api/positions'),
                            fetch('/api/velocities'),
                            fetch('/api/metrics')
                        ]);
                        
                        const status = await statusResponse.json();
                        const positions = await positionsResponse.json();
                        const velocities = await velocitiesResponse.json();
                        const metrics = await metricsResponse.json();
                        
                        updateAllData({
                            system_status: status,
                            positions: positions,
                            velocities: velocities,
                            metrics: metrics
                        });
                        
                        if (!isConnected) {
                            document.getElementById('connectionStatus').innerHTML = '🟢 HTTP接続';
                            document.getElementById('connectionStatus').className = 'connection-status connected';
                        }
                        
                    } catch (error) {
                        if (!demoMode) {
                            addConsoleMessage('⚠️ API接続エラー - デモモードに切り替えます');
                            startDemoMode();
                        }
                    }
                }
            }, 1000);
        }
        
        // HTTP APIによる定期取得も開始
        setTimeout(fetchDataPeriodically, 5000);
        
        // ページアンロード時の処理
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
        });
        
        // レスポンシブ対応
        window.addEventListener('resize', function() {
            // チャートのリサイズ
            const chartIds = ['currentPositionsXY', 'heightChart', 'velocityChart', 'metricsChart'];
            chartIds.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.data) {
                    Plotly.Plots.resize(element);
                }
            });
        });
        
        // 初期メッセージ
        setTimeout(function() {
            if (demoMode) {
                addConsoleMessage('🎯 デモモードで動作中 - 模擬データを表示しています');
            } else if (isConnected) {
                addConsoleMessage('🎯 ROSシステムに接続済み - リアルタイムデータを受信中');
            } else {
                addConsoleMessage('🔄 ROSシステムへの接続を試行中...');
            }
        }, 1000);
        
    </script>
</body>
</html>